<%- include('../layouts/userHeader.ejs') %>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<div class="container mx-auto mt-8 px-4">
  <nav class="flex" aria-label="Breadcrumb">
  <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
    <li class="inline-flex items-center">
      <a href="/home" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
        <svg class="w-3 h-3 me-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
          <path d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2a1 1 0 0 0 1.414 1.414L2 10.414V18a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-7.586l.293.293a1 1 0 0 0 1.414-1.414Z"/>
        </svg>
        Home
      </a>
    </li>
    <li>
      <div class="flex items-center">
        <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
        </svg>
        <a href="/profile" class="ms-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ms-2 dark:text-gray-400 dark:hover:text-white">Profile</a>
      </div>
    </li>
    <li aria-current="page">
      <div class="flex items-center">
        <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
        </svg>
        <span class="ms-1 text-sm font-medium text-gray-500 md:ms-2 dark:text-gray-400">Orders</span>
      </div>
    </li>
  </ol>
</nav>

  <div class="flex justify-center">
      <div class="w-full max-w-4xl">
          <!-- Order Card -->
          <% orderDetails.forEach(order => { %>
              <div class="mb-6 overflow-hidden bg-white rounded-lg shadow-md border border-gray-100">
                  <% order.items.forEach(item => { %>
                    
                      <div class="flex flex-col md:flex-row p-6 gap-6">
                          <a href="/orders/details/<%= order._id %>">
                            <img src="/uploads/<%= item.productImage %>" 
                              class="w-full md:w-48 h-48 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity">
                          </a>
                          
                          <div class="flex-1 space-y-4">
                              <div class="flex justify-between items-start">
                                  <h5 class="text-xl font-semibold text-gray-900">
                                      <%=item.productId.name%>
                                  </h5>
                                  <p class="text-lg font-bold text-gray-900">
                                    <i class="fa-solid fa-indian-rupee-sign"></i><%= item.productDiscountPrice.toFixed(2) %> x <%= item.productCount %>
                                  </p>
                              </div>

                              <!-- Delivery Status Section -->
                              <div id="delivery-status-<%= order._id %>" class="space-y-2">
                                  <% if (item.productStatus === 'Cancelled') { %>
                                      <div class="flex items-center gap-2">
                                          <span class="w-2.5 h-2.5 rounded-full bg-red-500"></span>
                                          <strong class="font-medium text-red-600">Cancelled</strong>
                                      </div>
                                      <p class="text-gray-600 text-sm">Your order has been cancelled.</p>
                                  <% } else if (item.productStatus === 'Delivered') { %>
                                      <div class="flex items-center gap-2">
                                          <span class="w-2.5 h-2.5 rounded-full bg-green-500"></span>
                                          <strong class="font-medium text-green-600">Delivered</strong>
                                          <span class="text-gray-600">on <%= order.deliveryDate %></span>
                                      </div>
                                      <p class="text-gray-600 text-sm">Your item has been delivered.</p>
                                  <% } else if (item.productStatus === 'Pending') { %>
                                      <div class="flex items-center gap-2">
                                          <span class="w-2.5 h-2.5 rounded-full bg-yellow-500"></span>
                                          <strong class="font-medium text-yellow-600">Pending</strong>
                                      </div>
                                      <p class="text-gray-600 text-sm">Your order is Pending.</p>
                                  <% }else if (item.productStatus === 'Requested') { %>
                                    <div class="flex items-center gap-2">
                                      <span class="w-2.5 h-2.5 rounded-full bg-violet-500"></span>
                                      <strong class="font-medium text-violet-600">Requested</strong>
                                  </div>
                                  <p class="text-gray-600 text-sm">Your Request has been sent.</p>
                                   <%}else if (item.productStatus === 'Rejected'){%>
                                    <div class="flex items-center gap-2">
                                      <span class="w-2.5 h-2.5 rounded-full bg-gray-500"></span>
                                      <strong class="font-medium text-gray-600">Rejected</strong>
                                  </div>
                                  <p class="text-gray-600 text-sm">Your Request has been Rejected</p>
                                  <%}else { %>
                                      <div class="flex items-center gap-2">
                                          <span class="w-2.5 h-2.5 rounded-full bg-blue-500"></span>
                                          <strong class="font-medium text-blue-600">Status: <%= item.productStatus %></strong>
                                      </div>
                                      <p class="text-gray-600 text-sm">Your order status is <%=  item.productStatus  %>.</p>
                                  <% } %>
                              </div>

                              <!-- View Details Button -->
                              <a href="/orders/details/<%= order._id %>" 
                                 class="inline-flex items-center text-blue-600 hover:text-blue-700 text-sm font-medium">
                                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                  </svg>
                                  View Order Details
                              </a>

                              <a href="#" class="inline-flex items-center text-green-600 hover:text-green-700 text-sm font-medium ml-4">
                                  <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                  </svg>
                                  Rate & Review Product
                              </a>
                            
                              <!-- Cancel and Return button -->
                              <% if(item.productStatus === 'Delivered') { %>
                                <div class="flex flex-wrap gap-3 pt-4">
                                  <button onclick="openModal('<%= order._id %>','<%= item.productId._id%>', 'return')" 
                                          class="px-4 py-2 text-sm font-medium text-white bg-red-700 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-700 focus:ring-offset-2 transition-colors">
                                    Return Order
                                  </button>
                                </div>
                              <% } else { %>
                                <%if(item.productStatus === 'Cancelled'||item.productStatus === 'Returned'||item.productStatus === 'Requested'||item.productStatus === 'Rejected'){ %>
                                <%  }else{ %>
                                <div class="flex flex-wrap gap-3 pt-4">
                                  <button onclick="openModal('<%= order._id %>','<%=item.productId._id%>', 'cancel')" 
                                          class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors">
                                    Cancel Order
                                  </button>
                                </div>
                                <%    } %>
                              <% } %>

                              <% if(item.productStatus === 'Pending'){ %>
                                <% if(!order.paid ) { %>
                                  <div class="flex flex-col items-center p-4 bg-red-100 rounded-lg shadow-lg space-y-4">
                                    <p class="text-xl font-medium text-red-600">Oops! Payment Failed</p>
                                    <p class="text-gray-700 text-center">
                                      There was an issue with your payment. Please try again to complete your purchase.
                                    </p>
                                    <button 
                                      type="button" 
                                      onclick="retryPayment('<%=order._id%>')" 
                                      class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-md transition duration-200 ease-in-out transform hover:scale-105 focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    >
                                      Pay Now
                                    </button>
                                  </div>
                                <% } %>
                              <% } %> 
                          </div>
                      </div>

                      <!-- Cancel/Return Modal -->
                      <div id="cancelModal" class="hidden fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 z-50">
                        <div class="bg-white rounded-lg w-full max-w-md mx-4 p-6">
                          <h2 class="text-lg font-semibold mb-4" id="modalTitle">Reason for Action</h2>
                          <form id="cancelForm">
                              <input type="hidden" id="orderId" name="orderId" value="<%=order._id%>">
                              <input type="hidden" id="actionType" name="actionType" value="">
                              <input type="hidden" id="productId" value="<%=order.items.productId %>">
                        
                              <div class="mb-4">
                                <label for="reason" class="block text-gray-700 mb-2">Enter Reason:</label>
                                <textarea id="reason" name="reason" class="w-full p-2 border border-gray-300 rounded-md" rows="3" required></textarea>
                              </div>
                              
                              <div class="flex justify-end gap-3">
                                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Submit</button>
                              </div>
                          </form>
                        </div>
                      </div>
                  <% }) %>
              </div>
          <% }) %>

          <!-- Pagination -->
          <div class="mt-4 flex justify-center space-x-4">
            <% if (currentPage > 1) { %>
              <a href="?page=<%= currentPage - 1 %>&limit=10" class="bg-gray-200 text-black px-4 py-2 rounded hover:bg-gray-300">Previous</a>
            <% } %>
            
            <% for (let i = 1; i <= totalPage; i++) { %>
              <a href="?page=<%= i %>&limit=10" class="bg-gray-200 text-black px-4 py-2 rounded hover:bg-gray-300 <%= currentPage === i ? 'bg-gray-400' : '' %>">
                <%= i %>
              </a>
            <% } %>
            
            <% if (currentPage < totalPage) { %>
              <a href="?page=<%= currentPage + 1 %>&limit=10" class="bg-gray-200 text-black px-4 py-2 rounded hover:bg-gray-300">Next</a>
            <% } %>
          </div>
        
          <!-- No More Results Message -->
          <div class="text-center py-8 border-t border-gray-100">
              <p class="text-gray-500 font-medium">No More Results To Display</p>
          </div>
      </div>
  </div>
</div>

<!-- Include SweetAlert2 Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Open Modal for Cancel/Return
function openModal(orderId, productId, action) {
    document.getElementById('cancelModal').classList.remove('hidden');
    document.getElementById('orderId').value = orderId;
    document.getElementById('productId').value = productId;
    document.getElementById('actionType').value = action;
    document.getElementById('modalTitle').innerText = `Reason for ${action.charAt(0).toUpperCase() + action.slice(1)} Order`;
}

// Close Modal Function
function closeModal() {
    document.getElementById('cancelModal').classList.add('hidden');
    document.getElementById('reason').value = '';
}

// JavaScript for submitting the cancel/return form with reason
document.getElementById('cancelForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const orderId = document.getElementById('orderId').value;
    const productId = document.getElementById('productId').value;
    const actionType = document.getElementById('actionType').value;
    const reason = document.getElementById('reason').value;

    fetch(`/cancelOrder/${orderId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: actionType, reason: reason, productId: productId })
    })
    .then(response => response.json())
    .then(data => {
        Swal.fire({
            icon: 'success',
            title: 'Success',
            text: data.message,
            confirmButtonText: 'OK',
        }).then(() => {
            closeModal();
            location.reload();
        });
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred while processing your request.',
            confirmButtonText: 'OK'
        });
    });
});

function showError(message) {
    alert(message);
    console.error(message);
}

async function retryPayment(orderId) {
    try {
        const res = await fetch('/retryRazorPay', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ orderId })
        });

        if (res.ok) {
            const retryPaymentData = await res.json();
            const options = {
                key: 'rzp_test_KDYrLJHnu3O9Ip',
                amount: retryPaymentData.amount,
                currency: "INR",
                name: "CoveHive",
                order_id: retryPaymentData.razorpayOrderId.id,
                handler: async function (response) {
                    try {
                        const resData = {
                            orderId,
                            razorpayOrderId: response.razorpay_order_id,
                            paymentId: response.razorpay_payment_id,
                        };
                        const payment = await fetch('/retryPayment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(resData)
                        });

                        if (payment.ok) {
                            window.location.href = "/conform-order";
                        } else {
                            const error = await payment.text();
                            showError(error);
                        }
                    } catch (error) {
                        console.error(`Handler error: ${error}`);
                    }
                },
                prefill: {
                    name: retryPaymentData.address.contactName,
                    email: retryPaymentData.address.street,
                    contact: retryPaymentData.address.pincode
                },
                notes: {
                    address: retryPaymentData.address
                },
                theme: {
                    color: "#3399cc"
                },
                "modal": {
                    "ondismiss": function () {
                        window.location.href = '/orders';
                    }
                }
            };
            const rzp1 = new Razorpay(options);
            rzp1.on('payment.failed', function (response) {
                showError('Payment Failure');
            });
            rzp1.open();
        } else {
            const error = await res.text();
            showError(error);
        }
    } catch (error) {
        console.error(`Error from retry payment fetch: ${error}`);
    }
}
</script>

<%- include('../layouts/userFooter.ejs') %>