

<% if(user){ %>
  <%- include('../layouts/userHeader.ejs') %>
<%}else{%>
  <%- include('../layouts/landingNav.ejs') %>
<%} %>
<div id="toast-container" style="position: fixed; top: 10px; right: 10px; z-index: 1000;"></div>

<ul class="flex items-center font-[sans-serif] space-x-4 mt-4">
  <% if (currentRoute == '/home') { %>
    <a href="/home">
      <li class="text-gray-500 text-base cursor-pointer">Home</li>
    </a>
  <% } else { %>
  <a href="/"><li class="text-gray-500 text-base cursor-not-allowed">Home</li></a>  
  <% } %>
  <li>
    <svg xmlns="http://www.w3.org/2000/svg" class="fill-gray-400 w-3.5 -rotate-90" viewBox="0 0 24 24">
      <path fill-rule="evenodd"
        d="M11.99997 18.1669a2.38 2.38 0 0 1-1.68266-.69733l-9.52-9.52a2.38 2.38 0 1 1 3.36532-3.36532l7.83734 7.83734 7.83734-7.83734a2.38 2.38 0 1 1 3.36532 3.36532l-9.52 9.52a2.38 2.38 0 0 1-1.68266.69734z"
        clip-rule="evenodd" data-original="#000000"></path>
    </svg>
  </li>
  <a href="/products/<%= product._id %>">
    <li class="text-gray-500 text-base cursor-pointer"><%= product.name %></li>
  </a>
</ul>
<body>
    <div class="font-sans">
        <div class="p-4 lg:max-w-5xl max-w-lg mx-auto">
            <div class="grid items-start grid-cols-1 lg:grid-cols-2 gap-6 max-lg:gap-12">

                <div class="w-full lg:sticky top-0 sm:flex gap-2">
                    <div class="sm:space-y-3 w-16 max-sm:w-12 max-sm:flex max-sm:mb-4 max-sm:gap-4">
                        <img src="/uploads/<%= product.image[2] %>" alt="<%= product.name %>" class="thumbnail w-full cursor-pointer rounded-md" />
                        <img src="/uploads/<%= product.image[1] %>" alt="<%= product.name %>" class="thumbnail w-full cursor-pointer rounded-md" />
                        <img src="/uploads/<%= product.image[0] %>" alt="<%= product.name %>" class="thumbnail w-full cursor-pointer rounded-md" />
                    </div>
                    <div class="relative w-4/5 rounded-md " id="image-container">
                        <img id="largeImage" src="/uploads/<%= product.image[0] %>" alt="<%= product.name %>" class="w-full object-cover" />
                        <div id="magnifier" class="magnifier" style="display: none;"></div>
                    </div>
                </div>
                
                

                  <div>
                    <h2 class="text-2xl font-bold text-gray-800"><%= product.name %></h2>
                    <div class="flex flex-wrap gap-4 mt-4">
                        <p class="text-gray-800 text-xl font-bold"><i class="fa-solid fa-indian-rupee-sign"></i>
                            <% if(product.discount > 0) { %>
                                <% const discountAmount = (product.price * product.discount) / 100; %>  
                                <% const discountedPrice = product.price - discountAmount; %>
                                <%= discountedPrice.toFixed(2) %> <!-- Output the discounted price -->
                            <% } else { %>
                                <%= product.price.toFixed(2) %> <!-- Output the original price if no discount -->
                            <% } %>
                        </p>
                        <p class="text-gray-400 text-xl"><strike><%= product.price %></strike> <span class="text-sm font-semibold ml-1.5 text-red-600 bg-red-100 px-2 py-1 rounded">
                            <%= product.discount %>% off
                          </span>
                          </p>
                    </div>
                    
                    <div class="flex items-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                          class="size-6 text-yellow-500">
                          <path fill-rule="evenodd"
                            d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z"
                            clip-rule="evenodd" />
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                          class="size-6 text-yellow-500">
                          <path fill-rule="evenodd"
                            d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z"
                            clip-rule="evenodd" />
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                          class="size-6 text-yellow-500">
                          <path fill-rule="evenodd"
                            d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z"
                            clip-rule="evenodd" />
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                          class="size-6 text-yellow-500">
                          <path fill-rule="evenodd"
                            d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z"
                            clip-rule="evenodd" />
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                          class="size-6 text-yellow-500">
                          <path fill-rule="evenodd"
                            d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z"
                            clip-rule="evenodd" />
                        </svg>
                        <span class="ml-2 text-gray-600">4.5 (120 reviews)</span>
                      </div>
                    
                    <div class="flex items-center mb-4">
                        <!-- Star rating SVGs -->
                        <span class="ml-2 text-sm font-medium rounded-full px-2.5 py-1">
                            <% if(product.stock > 0) { %>
                              <span class="text-green-700 bg-green-100">
                                In stock: <%= product.stock %> units
                              </span>
                            <% } else { %>
                              <span class="text-red-700 bg-red-100">
                                Out of Stock
                              </span>
                            <% } %>
                          </span>
                       
                    </div>
                  
                    <div class="mt-8 flex space-x-4 justify-center">
                      <form id="addToCartForm<%= product._id %>" action="/cart/add/<%= product._id %>" method="POST" onsubmit="addToCart( event,'123')">
                        <input type="hidden" name="productId" value="<%= product._id %>">
                        <button type="submit" id="add-to-cart" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-md transition duration-200 ease-in-out transform hover:scale-105 focus:ring-2 focus:ring-blue-500">
                            Add to Cart
                        </button>
                    </form>
                    
                      <!-- <a href="/cart/add/<%= product._id %>"> <button type="submit" id="add-to-cart" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-md transition duration-200 ease-in-out transform hover:scale-105 focus:ring-2 focus:ring-blue-500">
                        Add to Cart
                      </button> </a> -->
                      <button type="button" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-md transition duration-200 ease-in-out transform hover:scale-105 focus:ring-2 focus:ring-green-500">
                        Buy Now
                      </button>
                    </div>
                          
                    <!-- <div class="mb-6">
                        <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity:</label>
                        <input type="number" id="quantity" name="quantity" min="1" value="1"
                                      class="w-12 text-center rounded-md border-gray-300  shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                      </div> -->
              
                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-gray-800">About the item</h3>
                        <ul class="space-y-3 list-disc mt-4 pl-4 text-sm text-gray-800">
                            <%= product.description %>
                        </ul>
                    </div>

                    <button type="button" class="w-full mt-8 px-6 py-2.5 border border-blue-600 bg-transparent text-gray-800 text-sm font-semibold rounded-md">Read all reviews</button>
                </div>
                
            </div>
        </div>
    </div>

    <section class="py-16 bg-white border-t border-navy">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold mb-10 text-center text-navy">Related Products</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                <% relatedProducts.forEach(relatedProduct => { %>
                    <div class="bg-lightGray rounded-lg overflow-hidden shadow-lg transition duration-300 transform hover:scale-105">
                       <a href="/products/<%= relatedProduct._id %>"><img src="/uploads/<%= relatedProduct.image[0] %>  %>" alt="<%= relatedProduct.name %>" class="w-full h-48 object-cover"></a> 
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-navy mb-2"><%= relatedProduct.name %></h3>
                            <p class="text-xl font-bold text-black"><%= relatedProduct.price.toFixed(2) %></p> <!-- Assuming price is a number -->
                        </div>
                    </div>
                <% }); %>
            </div>
        </div>
      </section>
      <% if(true){ %>
        
      <%} %>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify-js.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Image magnifier functionality
    const largeImage = document.getElementById('largeImage');
    const magnifier = document.getElementById('magnifier');
    const imageContainer = document.getElementById('image-container');

    if (imageContainer) {
        imageContainer.addEventListener('mousemove', function(e) {
            const { left, top, width, height } = imageContainer.getBoundingClientRect();
            const x = e.pageX - left - window.pageXOffset;
            const y = e.pageY - top - window.pageYOffset;

            magnifier.style.display = 'block';
            magnifier.style.left = x - magnifier.offsetWidth / 2 + 'px';
            magnifier.style.top = y - magnifier.offsetHeight / 2 + 'px';

            if (x < 0 || y < 0 || x > width || y > height) {
                magnifier.style.display = 'none';
            } else {
                const zoomLevel = 2;
                const offsetX = -(x * zoomLevel - magnifier.offsetWidth / 2);
                const offsetY = -(y * zoomLevel - magnifier.offsetHeight / 2);

                magnifier.style.backgroundImage = `url(${largeImage.src})`;
                magnifier.style.backgroundSize = `${largeImage.width * zoomLevel}px ${largeImage.height * zoomLevel}px`;
                magnifier.style.backgroundPosition = `${offsetX}px ${offsetY}px`;
            }
        });

        imageContainer.addEventListener('mouseleave', function() {
            magnifier.style.display = 'none';
        });
    }

    // Thumbnail click functionality
    const thumbnails = document.querySelectorAll('.thumbnail');
    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            largeImage.src = this.src;
            magnifier.style.display = 'none';
        });
    });
//sweet alert
    async function addToCart(event, productId) {
        event.preventDefault(); // Prevent default form submission

        // Get the form data
        const form = document.getElementById(`addToCartForm${productId}`);
        const formData = new FormData(form);
       
        // Show confirmation dialog
        Swal.fire({
            title: "Do you want to save the changes?",
            showDenyButton: true,
            showCancelButton: true,
            confirmButtonText: "Save",
            denyButtonText: "Don't save"
        }).then(async (result) => {
            if (result.isConfirmed) {
                // If confirmed, proceed with the add to cart action
                try {
                    const response = await fetch(`/cart/add/${productId}`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        Swal.fire("Saved!", "", "success");
                        updateCartCount(result.cartItemCount); // Function to update the cart count display
                    } else {
                        Swal.fire(result.message || 'Something went wrong. Please try again.', '', 'error');
                    }
                } catch (error) {
                    console.error('Error adding to cart:', error);
                    Swal.fire('Failed to add to cart. Please try again.', '', 'error');
                }
            } else if (result.isDenied) {
                Swal.fire("Changes are not saved", "", "info");
            }
        });
    }

    function updateCartCount(count) {
        // Update the cart item count in the UI as needed
        document.getElementById('cartCount').innerText = count; // Example: update an element with id 'cartCount'
    }
});
  
  
      </script>
      <div>
        <span>Cart Items: <span id="cartCount">0</span></span>
    </div>
      <%- include('../layouts/userFooter.ejs') %>
 
    

<style>
    .magnifier {
  position: absolute;
  border: 2px solid #ccc;
  border-radius: 50%;
  width: 150px; /* Adjust as needed */
  height: 150px; /* Adjust as needed */
  pointer-events: none; /* Prevent interactions with the magnifier */
  background-repeat: no-repeat;
  background-size: contain;
  z-index: 10; /* Ensure it appears above the image */
} 
.toast {
    min-width: 200px;
    margin: 10px;
    padding: 15px;
    color: #fff;
    border-radius: 5px;
    opacity: 0.9;
    transition: opacity 0.3s ease;
}
.toast-success {
    background-color: #4CAF50; /* Green */
}
.toast-error {
    background-color: #F44336; /* Red */
}  
</style>