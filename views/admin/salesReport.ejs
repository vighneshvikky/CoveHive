<%- include('../layouts/header.ejs') %>
<div class="flex ml-64">
  <%- include('../layouts/sidebar.ejs') %>

  <div class="container mx-auto px-4 py-8 flex-1">
    <!-- Header Section -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Sales Report</h1>
          <p class="text-sm text-gray-500 mt-1">
            Track and analyze your sales performance
          </p>
        </div>

        <div class="flex gap-3">
          <!-- Filter Dropdown -->
          <div class="relative">
            <select
              id="filterOption"
              class="bg-white border border-gray-300 text-gray-700 px-5 py-2.5 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm hover:border-gray-400 transition-all cursor-pointer"
            >
              <option value="">All Time</option>
              <option value="day">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
              <option value="year">This Year</option>
            </select>
          </div>

          <!-- Export Dropdown -->
          <div class="relative">
            <select
              id="export"
              class="bg-blue-600 border border-blue-600 text-white px-5 py-2.5 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-sm hover:bg-blue-700 transition-all cursor-pointer"
            >
              <option value="">üì• Export Report</option>
              <option value="excel">üìä Excel Sheet</option>
              <option value="pdf">üìÑ PDF Document</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <!-- Overall Sales Count Card -->
      <div
        class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform duration-200"
      >
        <div class="flex items-center justify-between">
          <div>
            <p
              class="text-blue-100 text-sm font-medium uppercase tracking-wide"
            >
              Total Orders
            </p>
            <p id="overallSalesCount" class="text-4xl font-bold mt-2">
              <%= overallSalesCount %>
            </p>
          </div>
          <div class="bg-blue-400 bg-opacity-30 rounded-full p-4">
            <svg
              class="w-8 h-8"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
              ></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Overall Order Amount Card -->
      <div
        class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform duration-200"
      >
        <div class="flex items-center justify-between">
          <div>
            <p
              class="text-green-100 text-sm font-medium uppercase tracking-wide"
            >
              Total Revenue
            </p>
            <p id="overallOrderAmount" class="text-4xl font-bold mt-2">
              ‚Çπ <%= overallOrderAmount.toFixed(2) %>
            </p>
          </div>
          <div class="bg-green-400 bg-opacity-30 rounded-full p-4">
            <svg
              class="w-8 h-8"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Overall Coupon Discount Card -->
      <div
        class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition-transform duration-200"
      >
        <div class="flex items-center justify-between">
          <div>
            <p
              class="text-purple-100 text-sm font-medium uppercase tracking-wide"
            >
              Total Discounts
            </p>
            <p id="totalCouponDiscount" class="text-4xl font-bold mt-2">
              ‚Çπ <%= totalCouponDiscount.toFixed(2) %>
            </p>
          </div>
          <div class="bg-purple-400 bg-opacity-30 rounded-full p-4">
            <svg
              class="w-8 h-8"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
              ></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Sales Report Table -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th
                scope="col"
                class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                Order ID
              </th>
              <th
                scope="col"
                class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                User ID
              </th>
              <th
                scope="col"
                class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                Order Date
              </th>
              <th
                scope="col"
                class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                Order Amount
              </th>
              <th
                scope="col"
                class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                Coupon Discount
              </th>
              <th
                scope="col"
                class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                Payment Status
              </th>
              <th
                scope="col"
                class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
              >
                Payment Method
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% data.forEach(data =>{ %>
            <tr class="hover:bg-gray-50 transition-colors">
              <td class="px-6 py-4 text-sm font-medium text-gray-900">
                <%= data.orderId %>
              </td>
              <td class="px-6 py-4 text-sm text-gray-600 font-mono">
                <%= data.userId.toString().substring(0, 4) + '...' +
                data.userId.toString().slice(-5) %>
              </td>
              <td class="px-6 py-4 text-sm text-gray-600">
                <%= new Date(data.createdAt).toLocaleDateString('en-GB') %>
              </td>
              <td class="px-6 py-4 text-sm font-semibold text-gray-900">
                ‚Çπ <%= data.totalPrice.toFixed(2) %>
              </td>
              <td class="px-6 py-4 text-sm font-semibold text-green-600">
                ‚Çπ <%= data.couponDiscount.toFixed(2) %>
              </td>
              <td class="px-6 py-4 text-sm">
                <span
                  class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full <%= data.orderStatus === 'Paid' ? 'bg-green-100 text-green-800' : data.orderStatus === 'Delivered' ? 'bg-blue-100 text-blue-800' : data.orderStatus === 'Shipped' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800' %>"
                >
                  <%= data.orderStatus %>
                </span>
              </td>
              <td class="px-6 py-4 text-sm text-gray-600">
                <%= data.paymentMethod %>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <div
      class="flex flex-col sm:flex-row justify-between items-center mt-6 gap-4"
    >
      <div class="text-sm text-gray-600">
        Showing page
        <span class="font-semibold text-gray-900" id="currentPage"
          ><%= currentPage %></span
        >
        of
        <span class="font-semibold text-gray-900" id="totalPages"
          ><%= totalPages %></span
        >
        <span class="mx-2">‚Ä¢</span>
        <span class="font-semibold text-gray-900" id="totalRecords"
          ><%= totalRecordsCount %></span
        >
        total records
      </div>
      <div class="inline-flex gap-2">
        <button
          id="prevPage"
          class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed transition-all"
        >
          ‚Üê Previous
        </button>
        <button
          id="nextPage"
          class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed transition-all"
        >
          Next ‚Üí
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let currentPage = parseInt(document.getElementById("currentPage").innerHTML);
  let totalPages = parseInt(document.getElementById("totalPages").innerHTML);
  let overallSalesCount = document.getElementById("overallSalesCount");
  let overallOrderAmount = document.getElementById("overallOrderAmount");
  let totalCouponDiscount = document.getElementById("totalCouponDiscount");

  function fetchSalesReport(page, filterOption = "") {
    const URL = `/admin/salesReport?page=${page}&filter=${filterOption}`;

    fetch(URL, {
      headers: {
        Accept: "application/json",
      },
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        overallSalesCount.innerHTML = data.overallSalesCount;
        overallOrderAmount.innerHTML = `‚Çπ ${data.overallOrderAmount.toFixed(
          2
        )}`;
        totalCouponDiscount.innerHTML = `‚Çπ ${data.totalCouponDiscount.toFixed(
          2
        )}`;

        updateReportTable(data.data);
        updatePagination(
          data.currentPage,
          data.totalPages,
          data.totalRecordsCount
        );
      })
      .catch((error) => console.error("Error fetching sales report:", error));
  }

  document
    .getElementById("filterOption")
    .addEventListener("change", function (event) {
      const selectedFilter = event.target.value;
      fetchSalesReport(1, selectedFilter);
    });

  function updateReportTable(data) {
    const tBody = document.querySelector("tbody");
    tBody.innerHTML = "";

    data.forEach((order) => {
      const statusClass =
        order.orderStatus === "Paid"
          ? "bg-green-100 text-green-800"
          : order.orderStatus === "Delivered"
          ? "bg-blue-100 text-blue-800"
          : order.orderStatus === "Shipped"
          ? "bg-yellow-100 text-yellow-800"
          : "bg-gray-100 text-gray-800";

      const row = document.createElement("tr");
      row.className = "hover:bg-gray-50 transition-colors";
      row.innerHTML = `
        <td class="px-6 py-4 text-sm font-medium text-gray-900">${
          order.orderId
        }</td>
        <td class="px-6 py-4 text-sm text-gray-600 font-mono">${
          order.userId.substring(0, 4) + "..." + order.userId.slice(-5)
        }</td>
        <td class="px-6 py-4 text-sm text-gray-600">${new Date(
          order.createdAt
        ).toLocaleDateString("en-GB")}</td>
        <td class="px-6 py-4 text-sm font-semibold text-gray-900">‚Çπ ${order.totalPrice.toFixed(
          2
        )}</td>
        <td class="px-6 py-4 text-sm font-semibold text-green-600">‚Çπ ${order.couponDiscount.toFixed(
          2
        )}</td>
        <td class="px-6 py-4 text-sm">
          <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
            ${order.orderStatus}
          </span>
        </td>
        <td class="px-6 py-4 text-sm text-gray-600">${order.paymentMethod}</td>
      `;
      tBody.appendChild(row);
    });
  }

  function updatePagination(current, total, totalRecords) {
    currentPage = current;
    totalPages = total;

    document.getElementById("currentPage").innerText = current;
    document.getElementById("totalPages").innerText = total;
    document.getElementById("totalRecords").innerText = totalRecords;

    document.getElementById("prevPage").disabled = currentPage === 1;
    document.getElementById("nextPage").disabled = currentPage === totalPages;
  }

  document.getElementById("prevPage").addEventListener("click", function () {
    if (currentPage > 1) {
      fetchSalesReport(
        currentPage - 1,
        document.getElementById("filterOption").value
      );
    }
  });

  document.getElementById("nextPage").addEventListener("click", function () {
    if (currentPage < totalPages) {
      fetchSalesReport(
        currentPage + 1,
        document.getElementById("filterOption").value
      );
    }
  });

  document
    .getElementById("export")
    .addEventListener("change", function (event) {
      const selectedExport = event.target.value;

      if (selectedExport) {
        const filterOption = document.getElementById("filterOption").value;
        exportReport(selectedExport, filterOption);
        this.value = ""; // Reset dropdown
      }
    });

  function exportReport(format, filterOption) {
    const URL = `/admin/exportReport?format=${format}&filter=${filterOption}`;

    fetch(URL)
      .then((response) => response.blob())
      .then((blob) => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `sales_report.${format === "excel" ? "xlsx" : "pdf"}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      })
      .catch((error) => console.error("Error exporting report:", error));
  }
</script>
<%- include('../layouts/footer.ejs') %>
