<%- include('../layouts/header.ejs') %>

<form action="/admin/products/edit/<%= product._id %>" method="POST" enctype="multipart/form-data" class="bg-white p-8 rounded-md shadow-md">

    <div class="mb-4">
        <label for="name" class="block text-gray-700">Product Name</label>
        <input type="text" id="name" name="name" value="<%= product.name %>" class="w-full p-2 border border-gray-300 rounded-md" required>
    </div>

    <!-- Product Description -->
    <div class="mb-4">
        <label for="description" class="block text-gray-700">Description</label>
        <textarea id="description" name="description" class="w-full p-2 border border-gray-300 rounded-md" rows="5" required><%= product.description %></textarea>
    </div>

    <!-- Product Price -->
    <div class="mb-4">
        <label for="price" class="block text-gray-700">Price</label>
        <input type="number" id="price" name="price" value="<%= product.price %>" class="w-full p-2 border border-gray-300 rounded-md" required>
    </div>

    <!-- Product Category -->   
    <div class="mb-4">
        <label for="category" class="block text-gray-700">Category</label>
        <select id="category" name="category" class="w-full p-2 border border-gray-300 rounded-md" required>
            <% categories.forEach(function(category) { %>
                <option value="<%= category._id %>" <%= category._id.equals(product.category._id) ? 'selected' : '' %> >
                    <%= category.name %>
                </option>
            <% }); %>
        </select>
    </div>
    
    
    

    <!-- Product Images -->
     <!-- Image Upload -->
 <div class="mb-4">
    <label class="block text-gray-700 text-sm font-bold mb-2" for="image">Product Images</label>
    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="file" id="imageInput" name="image" accept="image/*" >
 </div>
  <!-- Image Preview for Cropping -->
  <div class="cropper-container">
    <img id="imagePreview" />
  </div>
  
  <!-- Crop Buttons -->
  <div class="flex justify-between mt-4">
    <button type="button" id="cropButton" style="display: none;">Crop Image</button>
    <button type="button" id="cancelButton" style="display: none;">Cancel</button>
  </div>
  
  
    <!-- Submit Button -->
    <div class="font-[sans-serif] space-x-4 space-y-4 text-center mt-6">
        <button type="submit"
          class="px-5 py-2.5 rounded-lg text-sm tracking-wider font-medium border border-blue-700 outline-none bg-transparent hover:bg-blue-700 text-blue-700 hover:text-white transition-all duration-300">Add Product</button>
    </div>
  
    </div>



<div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg w-1/3">
      <h2 class="text-lg font-bold mb-4">Confirm Action</h2>
      <p id="modal-message" class="mb-6"></p>
      <div class="flex justify-end">
        <button id="cancel-btn" class="bg-gray-500 text-white px-4 py-2 rounded mr-2" onclick="closeModal()">Cancel</button>
        <form id="confirm-form" action="" method="POST" style="display: inline;">
          <input type="hidden" name="is_blocked" id="isBlocked" value="" />
          <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded">Confirm</button>
        </form>
      </div>
    </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script>
   let cropper;
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const cropButton = document.getElementById('cropButton');
    const cancelButton = document.getElementById('cancelButton');
    const productForm = document.getElementById('productForm');

    imageInput.addEventListener('change', function (event) {
        const files = event.target.files;
        if (files.length > 0) {
            const reader = new FileReader();
            reader.onload = function (e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                cropButton.style.display = 'inline-block'; // Show crop button
                cancelButton.style.display = 'inline-block'; // Show cancel button

                // Destroy previous cropper instance
                if (cropper) {
                    cropper.destroy();
                }

                // Initialize Cropper.js
                cropper = new Cropper(imagePreview, {
                    aspectRatio: 1, // Set to 1 for square cropping
                    viewMode: 1,
                    autoCropArea: 1,
                    responsive: true,
                    scalable: true,
                    zoomable: true,
                    rotatable: true,
                    minCropBoxWidth: 100, // Minimum crop box width
                    minCropBoxHeight: 100, // Minimum crop box height
                });
            };
            reader.readAsDataURL(files[0]);
        }
    });

    cropButton.addEventListener('click', function () {
        const canvas = cropper.getCroppedCanvas({
            width: 200, // Set desired width for cropped image
            height: 200, // Set desired height for cropped image
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
        });

        // Convert canvas to blob and append it to the form
        canvas.toBlob(function (blob) {
            const file = new File([blob], "croppedImage.png", { type: 'image/png' });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);

            // Set the file input with the cropped image
            imageInput.files = dataTransfer.files;

            // Optionally trigger the form submit
            cropButton.style.display = 'none';
            cancelButton.style.display = 'none';
            imagePreview.style.display = 'none';
            productForm.submit(); // This will now send the cropped image
        }, 'image/png'); // Specify the image format
    });

    cancelButton.addEventListener('click', function () {
        imageInput.value = ''; // Clear file input
        imagePreview.src = ''; // Reset image preview
        imagePreview.style.display = 'none'; // Hide preview
        cropButton.style.display = 'none'; // Hide crop button
        cancelButton.style.display = 'none'; // Hide cancel button
        if (cropper) {
            cropper.destroy(); // Destroy cropper instance
            cropper = null; // Reset cropper
        }
    }); 
</script>

<%- include('../layouts/footer.ejs') %>