<%- include('../layouts/header.ejs') %> <%- include('../layouts/sidebar.ejs') %>
<div class="ml-[250px] p-6">
  <div style="display: flex; min-height: 100vh">
    <!-- Main Content -->
    <div style="flex-grow: 1; background-color: black; color: #ffffff">
      <!-- Top section -->
      <div class="grid grid-cols-4 gap-4 p-4 bg-white">
        <!-- Total Daily Sales Card -->
        <div class="p-6 bg-white shadow rounded-lg border border-gray-200">
          <div class="flex justify-between items-center mb-2">
            <span class="text-2xl font-bold text-gray-800">₹ <%= (dailyOrder[0] && dailyOrder[0].totalSales ? dailyOrder[0].totalSales.toFixed() : "0.00") %></span>
          </div>
          <p class="text-sm text-gray-600">Total Daily Sales</p>
        </div>

        <!-- Total Daily Orders Card -->
        <div class="p-6 bg-white shadow rounded-lg border border-gray-200">
          <div class="flex justify-between items-center mb-2">
            <span class="text-2xl font-bold text-gray-800"><%= (dailyOrder[0] && dailyOrder[0].totalDailyOrders ? dailyOrder[0].totalDailyOrders : "0") %></span>
          </div>
          <p class="text-sm text-gray-600">Total Daily Orders</p>
        </div>

        <!-- Total Customers Card -->
        <div class="p-6 bg-white shadow rounded-lg border border-gray-200">
          <div class="flex justify-between items-center mb-2">
            <span class="text-2xl font-bold text-gray-800"><%= totalUsers %></span>
          </div>
          <p class="text-sm text-gray-600">Total Customers</p>
        </div>
      </div>

      <!-- Graph Section -->
      <div id="graph-data" class="grid grid-cols-4 mx-2 gap-2">
        <!-- Main Area Chart - 3/4 width -->
        <div class="col-span-3 max-w-full w-full bg-white rounded-lg shadow p-4 md:p-6">
          <div class="flex justify-between mb-5">
            <div>
              <h5 class="leading-none text-3xl font-bold text-gray-900 pb-2">₹ <%= finalTotalSaleAmount %></h5>
              <p class="text-base font-normal text-green-500">Total Sales</p>
            </div>
          </div>
          <!-- Chart.js Canvas -->
          <div style="height: 350px;">
            <canvas id="salesChart"></canvas>
          </div>
          <div class="grid grid-cols-1 items-center border-gray-200 border-t justify-between mt-5">
            <div class="flex justify-between items-center pt-5">
              <select id="mainGraphData" class="block px-4 py-2 rounded-lg shadow w-44 text-gray-700 bg-white">
                <option value="day">Day</option>
                <option value="week">Week</option>
                <option value="month">Month</option>
                <option value="year">Year</option>
              </select>
              <a href="/admin/salesReport" class="uppercase text-sm font-semibold inline-flex items-center rounded-lg text-blue-600 hover:text-blue-700 hover:bg-gray-100 px-3 py-2">
                Sales Report
                <svg class="w-2.5 h-2.5 ms-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
              </a>
            </div>
          </div>
        </div>

        <!-- Donut Chart - 1/4 width -->
        <div class="col-span-1 max-w-full w-full bg-white rounded-lg shadow py-5 md:p-6">
          <div class="flex justify-between mb-3">
            <h5 class="text-xl font-bold leading-none text-gray-900 pe-1">Category Performance</h5>
          </div>
          <!-- Chart.js Donut Canvas -->
          <div class="py-3 mb-3" style="height: 280px;">
            <canvas id="donutChart"></canvas>
          </div>
          <div class="flex justify-between items-center pt-5">
            <select id="categoryDropdown" class="block px-4 py-2 rounded-lg shadow w-44 text-gray-700 bg-white">
              <option value="day">Day</option>
              <option value="week">Week</option>
              <option value="month">Month</option>
              <option value="year">Year</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Table Section -->
      <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-semibold text-gray-100">Top Selling Products</h2>
          <div class="relative inline-block w-64">
            <label for="filter" class="block mb-1 text-gray-300">Filter By:</label>
            <select id="filter" class="w-full px-3 py-2 bg-gray-800 text-gray-300 border border-gray-600 rounded-md">
              <option value="day">Day</option>
              <option value="week">Week</option>
              <option value="month">Month</option>
              <option value="year">Year</option>
            </select>
          </div>
        </div>

        <div class="overflow-x-auto bg-white rounded-lg shadow">
          <table class="min-w-full bg-white border border-gray-200">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="py-3 px-4 text-left text-gray-700 font-semibold">Product Name</th>
                <th class="py-3 px-4 text-left text-gray-700 font-semibold">Total Quantity Sold</th>
                <th class="py-3 px-4 text-left text-gray-700 font-semibold">Revenue</th>
                <th class="py-3 px-4 text-left text-gray-700 font-semibold">Discount (%)</th>
              </tr>
            </thead>
            <tbody>
              <% if(topSellingProducts.length > 0 ){ %>
                <% topSellingProducts.forEach(product=>{ %>
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                  <td class="py-3 px-4 text-gray-600"><%= product._id.name %></td>
                  <td class="py-3 px-4 text-gray-600"><%= product.totalQuantitySold %></td>
                  <td class="py-3 px-4 text-gray-600"><%= product.totalRevenue.toFixed(2) %></td>
                  <td class="py-3 px-4 text-gray-600"><%= product._id.discount %>%</td>
                </tr>
                <% }) %>
              <% } else { %>
              <tr>
                <td colspan="4" class="py-4 px-4 text-gray-500 text-center">No product found</td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Data from server
    const categories = <%- categories %>;
    const totalSalesData = <%- totalSalesData %>;
    const totalProfitData = <%- totalProfitData %>;
    const initialCategoryLabels = <%- categoryLabels %>;
    const initialCategoryData = <%- categoryData %>;

    // ==================== AREA/LINE CHART ====================
    let salesChart = null;

    function renderSalesChart(labels, salesData) {
      const ctx = document.getElementById('salesChart').getContext('2d');
      
      // Destroy existing chart
      if (salesChart) {
        salesChart.destroy();
      }

      salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Sales',
            data: salesData,
            borderColor: '#1A56DB',
            backgroundColor: 'rgba(26, 86, 219, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#1A56DB',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: { family: 'Inter, sans-serif', size: 12 },
                color: '#374151'
              }
            },
            tooltip: {
              backgroundColor: '#1f2937',
              titleFont: { family: 'Inter, sans-serif' },
              bodyFont: { family: 'Inter, sans-serif' },
              callbacks: {
                label: (context) => `₹${context.parsed.y.toFixed(2)}`
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                font: { size: 12 },
                color: '#A0AEC0'
              }
            },
            y: {
              grid: {
                color: 'rgba(160, 174, 192, 0.2)',
                drawBorder: false
              },
              ticks: {
                font: { size: 12 },
                color: '#A0AEC0',
                callback: (value) => `₹${value}`
              }
            }
          }
        }
      });
    }

    // Initial render
    renderSalesChart(categories, totalSalesData);

    // Filter event
    document.getElementById('mainGraphData').addEventListener('change', function() {
      fetch(`/admin/dashboard?filter=${this.value}`, {
        headers: { 'Accept': 'application/json' }
      })
        .then(res => res.json())
        .then(data => renderSalesChart(data.categories, data.totalSalesData))
        .catch(err => console.error('Error:', err));
    });

    // ==================== DONUT CHART ====================
    let donutChart = null;

    function renderDonutChart(labels, data) {
      const ctx = document.getElementById('donutChart').getContext('2d');
      
      if (donutChart) {
        donutChart.destroy();
      }

      donutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: [
              '#1C64F2', '#16BDCA', '#9061F9', 
              '#FBBF24', '#F472B6', '#34D399'
            ],
            borderColor: '#ffffff',
            borderWidth: 2,
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '65%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: { family: 'Inter, sans-serif', size: 11 },
                color: '#374151',
                padding: 15,
                usePointStyle: true
              }
            },
            tooltip: {
              backgroundColor: '#1f2937',
              titleFont: { family: 'Inter, sans-serif' },
              bodyFont: { family: 'Inter, sans-serif' }
            }
          }
        }
      });
    }

    // Initial render
    renderDonutChart(initialCategoryLabels, initialCategoryData);

    // Filter event
    document.getElementById('categoryDropdown').addEventListener('change', function() {
      fetch(`/admin/dashboard?filter=${this.value}`, {
        headers: { 'Accept': 'application/json' }
      })
        .then(res => res.json())
        .then(data => renderDonutChart(data.categoryLabels, data.categoryData))
        .catch(err => console.error('Error:', err));
    });

    // ==================== TABLE FILTER ====================
    document.getElementById('filter').addEventListener('change', function() {
      fetch(`/admin/dashboard?filter=${this.value}`, {
        headers: { 'Accept': 'application/json' }
      })
        .then(res => res.json())
        .then(data => {
          const tbody = document.querySelector('tbody');
          tbody.innerHTML = '';
          
          if (data.topSellingProducts?.length > 0) {
            data.topSellingProducts.forEach(p => {
              tbody.innerHTML += `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                  <td class="py-3 px-4 text-gray-600">${p._id.name}</td>
                  <td class="py-3 px-4 text-gray-600">${p.totalQuantitySold}</td>
                  <td class="py-3 px-4 text-gray-600">${p.totalRevenue.toFixed(2)}</td>
                  <td class="py-3 px-4 text-gray-600">${p._id.discount}%</td>
                </tr>`;
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="4" class="py-4 px-4 text-gray-500 text-center">No products found</td></tr>';
          }
        })
        .catch(err => console.error('Error:', err));
    });
  </script>

  <%- include('../layouts/footer.ejs') %>
</div>