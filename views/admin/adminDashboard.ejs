<%- include('../layouts/header.ejs') %> <%- include('../layouts/sidebar.ejs') %>
<div class="ml-[250px] p-6">
  <div style="display: flex; min-height: 100vh">
    <!-- Main Content -->
    <div style="flex-grow: 1; background-color: black; color: #ffffff">
      <!-- Top section -->
      <div class="grid grid-cols-4 gap-4 p-4 bg-white">
        <div class="p-6 bg-white shadow rounded-lg border border-gray-200">
          <div class="flex justify-between items-center mb-2">
            <span class="text-2xl font-bold text-gray-800">₹ <%= (dailyOrder[0] && dailyOrder[0].totalSales ? dailyOrder[0].totalSales.toFixed() : "0.00") %></span>
          </div>
          <p class="text-sm text-gray-600">Total Daily Sales</p>
        </div>
        <div class="p-6 bg-white shadow rounded-lg border border-gray-200">
          <div class="flex justify-between items-center mb-2">
            <span class="text-2xl font-bold text-gray-800"><%= (dailyOrder[0] && dailyOrder[0].totalDailyOrders ? dailyOrder[0].totalDailyOrders : "0") %></span>
          </div>
          <p class="text-sm text-gray-600">Total Daily Orders</p>
        </div>
        <div class="p-6 bg-white shadow rounded-lg border border-gray-200">
          <div class="flex justify-between items-center mb-2">
            <span class="text-2xl font-bold text-gray-800"><%= totalUsers %></span>
          </div>
          <p class="text-sm text-gray-600">Total Customers</p>
        </div>
      </div>

      <!-- Graph Section -->
      <div id="graph-data" class="grid grid-cols-4 mx-2 gap-2">
        <!-- Main Area Chart -->
        <div class="col-span-3 max-w-full w-full bg-white rounded-lg shadow dark:bg-gray-800 p-4 md:p-6">
          <div class="flex justify-between mb-5">
            <div>
              <h5 class="leading-none text-3xl font-bold text-gray-900 dark:text-white pb-2">₹ <%= finalTotalSaleAmount %></h5>
              <p class="text-base font-normal text-green-500 dark:text-green-400">Total Sales</p>
            </div>
          </div>
          <!-- FIXED: Set explicit height on canvas parent AND canvas -->
          <div style="position: relative; height: 350px; width: 100%;">
            <canvas id="salesChart" style="height: 350px !important; width: 100% !important;"></canvas>
          </div>
          <div class="grid grid-cols-1 items-center border-gray-200 border-t dark:border-gray-700 justify-between mt-5">
            <div class="flex justify-between items-center pt-5">
              <select id="mainGraphData" class="block px-4 py-2 rounded-lg shadow w-44 text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700">
                <option value="day">Day</option>
                <option value="week">Week</option>
                <option value="month">Month</option>
                <option value="year">Year</option>
              </select>
              <a href="/admin/salesReport" class="uppercase text-sm font-semibold inline-flex items-center rounded-lg text-blue-600 hover:text-blue-700 dark:hover:text-blue-500 hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2">
                Sales Report
                <svg class="w-2.5 h-2.5 ms-1.5 rtl:rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
              </a>
            </div>
          </div>
        </div>

        <!-- Donut Chart -->
        <div class="col-span-1 max-w-full w-full bg-white rounded-lg shadow dark:bg-gray-800 py-5 md:p-6">
          <div class="flex justify-between mb-3">
            <div class="flex items-center">
              <h5 class="text-xl font-bold leading-none text-gray-900 dark:text-white pe-1">Category Performance</h5>
            </div>
          </div>
          <!-- FIXED: Set explicit height on canvas parent AND canvas -->
          <div class="py-3 mb-3" style="position: relative; height: 280px; width: 100%;">
            <canvas id="donutChart" style="height: 280px !important; width: 100% !important;"></canvas>
          </div>
          <div class="flex justify-between items-center pt-5">
            <select id="categoryDropdown" class="block px-4 py-2 rounded-lg shadow w-44 text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700">
              <option value="day">Day</option>
              <option value="week">Week</option>
              <option value="month">Month</option>
              <option value="year">Year</option>
            </select>
            <a href="#" class="uppercase text-sm font-semibold text-blue-600 hover:text-blue-700 dark:hover:text-blue-500 hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-lg">Filter</a>
          </div>
        </div>
      </div>

      <!-- Table Section -->
      <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-semibold text-gray-100">Top Selling Products</h2>
          <div class="relative inline-block w-64">
            <label for="filter" class="block mb-1 text-gray-300">Filter By:</label>
            <select id="filter" class="w-full px-3 py-2 bg-gray-800 text-gray-300 border border-gray-600 rounded-md">
              <option value="day">Day</option>
              <option value="week">Week</option>
              <option value="month">Month</option>
              <option value="year">Year</option>
            </select>
          </div>
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow">
          <table class="min-w-full bg-white border border-gray-200">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="py-3 px-4 text-left text-gray-700 font-semibold">Product Name</th>
                <th class="py-3 px-4 text-left text-gray-700 font-semibold">Total Quantity Sold</th>
                <th class="py-3 px-4 text-left text-gray-700 font-semibold">Revenue</th>
                <th class="py-3 px-4 text-left text-gray-700 font-semibold">Discount (%)</th>
              </tr>
            </thead>
            <tbody>
              <% if(topSellingProducts.length > 0 ){ %>
                <% topSellingProducts.forEach(product=>{ %>
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                  <td class="py-3 px-4 text-gray-600"><%= product._id.name %></td>
                  <td class="py-3 px-4 text-gray-600"><%= product.totalQuantitySold %></td>
                  <td class="py-3 px-4 text-gray-600"><%= product.totalRevenue.toFixed(2) %></td>
                  <td class="py-3 px-4 text-gray-600"><%= product._id.discount %>%</td>
                </tr>
                <% }) %>
              <% } else { %>
              <tr>
                <td colspan="4" class="py-4 px-4 text-gray-500 text-center">No product found</td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js CDN - Use specific version -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // Data from server
    var categories = <%- categories %>;
    var totalSalesData = <%- totalSalesData %>;
    var totalProfitData = <%- totalProfitData %>;
    var initialCategoryLabels = <%- categoryLabels %>;
    var initialCategoryData = <%- categoryData %>;

    console.log("Initial categories:", categories);
    console.log("Initial sales data:", totalSalesData);

    // ==================== SALES LINE/AREA CHART ====================
    var salesChart = null;

    function renderSalesChart(labels, salesData) {
      var canvas = document.getElementById('salesChart');
      var ctx = canvas.getContext('2d');
      
      // Destroy existing chart if exists
      if (salesChart) {
        salesChart.destroy();
        salesChart = null;
      }

      // Create gradient
      var gradient = ctx.createLinearGradient(0, 0, 0, 350);
      gradient.addColorStop(0, 'rgba(26, 86, 219, 0.5)');
      gradient.addColorStop(1, 'rgba(26, 86, 219, 0.0)');

      // FIXED: Use requestAnimationFrame to ensure DOM is ready
      requestAnimationFrame(function() {
        salesChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Total Sales',
              data: salesData,
              borderColor: '#1A56DB',
              backgroundColor: gradient,
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#1A56DB',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 8,
              pointHoverBackgroundColor: '#1A56DB',
              pointHoverBorderColor: '#ffffff',
              pointHoverBorderWidth: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            // ANIMATION SETTINGS - Simplified for production
            animation: {
              duration: 1500,
              easing: 'easeOutQuart',
              onProgress: function(animation) {
                // Debug: uncomment to see animation progress
                // console.log('Animation progress:', animation.currentStep / animation.numSteps);
              },
              onComplete: function() {
                console.log('Sales chart animation complete');
              }
            },
            interaction: {
              mode: 'index',
              intersect: false
            },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: { family: 'Inter, sans-serif', size: 12, weight: '500' },
                  color: '#374151',
                  usePointStyle: true,
                  pointStyle: 'circle',
                  padding: 20
                }
              },
              tooltip: {
                enabled: true,
                backgroundColor: 'rgba(17, 24, 39, 0.95)',
                titleFont: { family: 'Inter, sans-serif', size: 14, weight: 'bold' },
                bodyFont: { family: 'Inter, sans-serif', size: 13 },
                padding: 12,
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                  label: function(context) {
                    return '  Sales: ₹' + context.parsed.y.toFixed(2);
                  }
                }
              }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: {
                  font: { size: 12, family: 'Inter, sans-serif' },
                  color: '#6B7280'
                }
              },
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(156, 163, 175, 0.2)',
                  drawBorder: false
                },
                ticks: {
                  font: { size: 12, family: 'Inter, sans-serif' },
                  color: '#6B7280',
                  callback: function(value) {
                    return '₹' + value;
                  }
                }
              }
            }
          }
        });
      });
    }

    // ==================== DONUT CHART ====================
    var donutChart = null;

    function renderDonutChart(labels, data) {
      var canvas = document.getElementById('donutChart');
      var ctx = canvas.getContext('2d');
      
      if (donutChart) {
        donutChart.destroy();
        donutChart = null;
      }

      // FIXED: Use requestAnimationFrame to ensure DOM is ready
      requestAnimationFrame(function() {
        donutChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: [
                '#1C64F2',
                '#16BDCA',
                '#9061F9',
                '#FBBF24',
                '#F472B6',
                '#34D399',
                '#EF4444',
                '#8B5CF6'
              ],
              borderColor: '#ffffff',
              borderWidth: 3,
              hoverOffset: 20,
              hoverBorderColor: '#ffffff',
              hoverBorderWidth: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            // ANIMATION SETTINGS - Simplified for production
            animation: {
              animateScale: true,
              animateRotate: true,
              duration: 1500,
              easing: 'easeOutQuart',
              onComplete: function() {
                console.log('Donut chart animation complete');
              }
            },
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  font: { family: 'Inter, sans-serif', size: 11, weight: '500' },
                  color: '#374151',
                  padding: 15,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                enabled: true,
                backgroundColor: 'rgba(17, 24, 39, 0.95)',
                titleFont: { family: 'Inter, sans-serif', size: 14, weight: 'bold' },
                bodyFont: { family: 'Inter, sans-serif', size: 13 },
                padding: 12,
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                  label: function(context) {
                    var total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                    var percentage = ((context.parsed / total) * 100).toFixed(1);
                    return '  ' + context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                  }
                }
              }
            }
          }
        });
      });
    }

    // ==================== INITIALIZE CHARTS ON DOM READY ====================
    // FIXED: Wait for DOM to be fully loaded and use setTimeout for extra safety
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCharts);
    } else {
      initCharts();
    }

    function initCharts() {
      // Small delay to ensure canvas is visible and has dimensions
      setTimeout(function() {
        console.log('Initializing charts...');
        renderSalesChart(categories, totalSalesData);
        renderDonutChart(initialCategoryLabels, initialCategoryData);
      }, 100);
    }

    // ==================== FILTER EVENT LISTENERS ====================
    document.getElementById('mainGraphData').addEventListener('change', function() {
      var selectedFilter = this.value;
      fetch('/admin/dashboard?filter=' + selectedFilter, {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      })
        .then(function(response) { return response.json(); })
        .then(function(data) {
          console.log("Received data:", data);
          renderSalesChart(data.categories, data.totalSalesData);
        })
        .catch(function(error) { console.error('Error:', error); });
    });

    document.getElementById('categoryDropdown').addEventListener('change', function() {
      var selectedFilter = this.value;
      fetch('/admin/dashboard?filter=' + selectedFilter, {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      })
        .then(function(response) { return response.json(); })
        .then(function(data) {
          console.log("Received category data:", data);
          renderDonutChart(data.categoryLabels, data.categoryData);
        })
        .catch(function(error) { console.error('Error:', error); });
    });

    // ==================== TABLE FILTER ====================
    document.getElementById('filter').addEventListener('change', function() {
      var filterValue = this.value;
      fetch('/admin/dashboard?filter=' + filterValue, {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      })
        .then(function(response) {
          if (!response.ok) throw new Error("Network error");
          return response.json();
        })
        .then(function(data) {
          console.log("Received table data:", data);
          updateTable(data.topSellingProducts);
        })
        .catch(function(error) { console.error('Error:', error); });
    });

    function updateTable(products) {
      var tbody = document.querySelector('tbody');
      tbody.innerHTML = '';

      if (products && products.length > 0) {
        products.forEach(function(product) {
          var row = '<tr class="border-b border-gray-200 hover:bg-gray-50">' +
            '<td class="py-3 px-4 text-gray-600">' + product._id.name + '</td>' +
            '<td class="py-3 px-4 text-gray-600">' + product.totalQuantitySold + '</td>' +
            '<td class="py-3 px-4 text-gray-600">' + product.totalRevenue.toFixed(2) + '</td>' +
            '<td class="py-3 px-4 text-gray-600">' + product._id.discount + '%</td>' +
            '</tr>';
          tbody.innerHTML += row;
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="4" class="py-4 px-4 text-gray-500 text-center">No products found for this filter</td></tr>';
      }
    }
  </script>

  <%- include('../layouts/footer.ejs') %>
</div>